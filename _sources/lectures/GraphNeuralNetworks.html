

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Graph Neural Networks &#8212; PHYS 503</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_sources/lectures/GraphNeuralNetworks';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Project 02" href="../Project_02.html" />
    <link rel="prev" title="Graph Neural Networks" href="../Week_12.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="PHYS 503 - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="PHYS 503 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    <span style="color:Blue">Instrumentation Physics: Applications of Machine Learning</span>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to Machine Learning and Data Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_01.html"><span style="color: blue;"><b>Course Introduction</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1vq4b3zxrhEMJbfeCH52hufBbXvTwhufEXdSs8mWY2ec/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="JupyterNumpy.html">Jupyter Notebooks and Numerical Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="Pandas.html">Handling Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_01.html">Homework 01: Numerical python and data handling</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_02.html"><span style="color: blue;"><b>Visualizing &amp; Finding Structure in Data</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1_LstEfghjdZUheyrqbjx4PK9y1J0cN-_hOdCInTldp8/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="Visualization.html">Visualizing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Clustering.html">Finding Structure in Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_02.html">Homework 02: Visualization and Expectation-Maximization</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_03.html"><span style="color: blue;"><b>Dimensionality, Linearity and Kernel Functions</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1x4bWQr7kEAh6Z6L7iaLdaNiY6SDTHtvHxzvjFM1wYnE/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="Dimensionality.html">Measuring and Reducing Dimensionality</a></li>
<li class="toctree-l2"><a class="reference internal" href="Nonlinear.html">Adapting Linear Methods to Non-Linear Data and Kernel Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_03.html">Homework 03: K-means and Principle Component Analysis</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Probability and Statistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_04.html"><span style="color: blue;"><b>Probability Theory</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1qW-gCHY3bQMmB0-klM0crTD9020UG3DTlT_awlOhy2A/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="ProbabilityTheory.html">Probability Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="ProbabilityDistributions.html">Important Probability Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_04.html">Homework 04: Probability Theory and Common Distributions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_05.html"><span style="color: blue;"><b>Kernel Density Estimation and Statistics</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1XZoeBdXzhcfezIbUrH0a9-4-QmM-5iNksLCB7X4q1wI/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="DensityEstimation.html">Estimating Probability Density from Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Statistics.html">Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="MonteCarloSamplingMethods.html">Monte Carlo and Sampling Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_05.html">Homework 05: Kernel Density Estimation, Covariance and Correlation</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bayesian Inference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_06.html"><span style="color: blue;"><b>Bayesian Statistics and Markov Chain Monte Carlo</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1L_lz0WbrrUu9qDPnKxYu5S_fCXKjl01Mrs2RnHN5_6E/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="BayesianInference.html">Bayesian Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="MarkovChainMonteCarlo.html">Markov Chain Monte Carlo in Practice</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_06.html">Homework 06: Bayesian Statistics and MCMC</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Project_01.html"><span style="color: blue;"><b>Project 01</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_HiggsTauTau.html">Higgs Boson Decaying to Tau Leptons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_ExoticParticles.html">Searching for Exotic Particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_GalaxyZoo.html">Galaxy Zoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_NuclearGeometryQGP.html">Nuclear Geometry and Characterization of the Quark Gluon Plasma</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_AberratedImages.html">Aberrated Image Recovery of Ultracold Atoms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_01_DarkEnergySurvey.html">Dark Energy Survey</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_07.html"><span style="color: blue;"><b>Stochastic Processes, Markov Chains &amp; Variational Inference</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/11Mzc9rBUcnEh_D3SKeDUoCW-iwIA9ilcxsx_4yuu32A/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="MarkovChains.html">Stochastic Processes and Markov-Chain Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="VariationalInference.html">Variational Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_07.html">Homework 07: Markov Chains</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_08.html"><span style="color: blue;"><b>Optimization and Model Selection</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1KshmOwKTWptL-3PASHrW6WT2PkH2ltU-XwoYOflhKQk/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="Optimization.html">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="ModelSelection.html">Bayesian Model Selection</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supervised Learning &amp; Cross Validation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_09.html"><span style="color: blue;"><b>Learning &amp; Cross Validation</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1a2cjkREM0LYxRjrLwrfHPTotM0n_CgVrZ_WQjEyc_Jc/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="Learning.html">Artificial Intelligence and Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="CrossValidation.html">Cross Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_08.html">Homework 08: Cross Validation</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Artificial Neural Networks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_10.html"><span style="color: blue;"><b>Supervised Learning &amp; Artificial Neural Networks</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1vyg7eSo5XaUAtYDwxmLY5qeUrwKxKqJcEEHPB40yVpE/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="SupervisedLearning.html">Supervised Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="ArtificialNeuralNetworks.html">Artificial Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_09.html">Homework 05: Artificial Neural Networks</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Deep Learning</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_11.html"><span style="color: blue;"><b>Deep Neural Networks</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1RnFI0k15C_m2j43QtFDGCFRBCcQ-Rx6EG-9U3EumOHc/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="DeepLearning.html">Deep Learning</a></li>





<li class="toctree-l2"><a class="reference internal" href="ConvolutionalRecurrentNeuralNetworks.html">Convolutional and Recurrent Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_10.html">Homework 10: Forecasting Projectile Motion with Recurrent Neural Networks</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../Week_12.html"><span style="color: blue;"><b>Graph Neural Networks</b></span></a><input checked="" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1fxZdnCU_8pWocQbjMQ5HUOSUL3MgbCyg3xFWxfeNaeY/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Graph Neural Networks</a></li>






</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Project_02.html"><span style="color: blue;"><b>Project 02</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_HiggsTauTau.html">Higgs Boson Decaying to Tau Leptons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_ExoticParticles.html">Searching for Exotic Particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_GalaxyZoo.html">Galaxy Zoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_NuclearGeometryQGP.html">Nuclear Geometry and Characterization of the Quark Gluon Plasma</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_AberratedImages.html">Aberrated Image Recovery of Ultracold Atoms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/Project_02_GravitationalWaves.html">Detection of Gravitational Waves</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_13.html"><span style="color: blue;"><b>AI Explainablility and Uncertainty Quantification</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1jGxr3j5t7Ahi3Ai6501dVJXOIzvlYMGhe9ZDqHlcfjo/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="AIExplainabilityUncertaintyQuantification.html">AI Explainability and Uncertainty Quantification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/Homework_11.html"><span style="color:Orange">Acknowledgments</span></a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Explainable AI and Accelerated Machine Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_14.html"><span style="color: blue;"><b>Unsupervised Learning and Anomaly Detection</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1-_9DcO71v6fQN1kNhKRH2d2iSjhs_Ddi2wLxiXy6RNg/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="UnsupervisedLearningAnomalyDetection.html">Unsupervised Learning and Anomaly Detection</a></li>

</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Accelerated Machine Learning and Inference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week_15.html"><span style="color: blue;"><b>Accelerated Machine Learning and Inference</b></span></a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1FbBa1MC9zhnxwbiiUJcxUiJ1hZF27JvwxS_jdTl7_gs/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="AcceleratedML.html">Accelerated Machine Learning and Inference</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/illinois-ipaml/MachineLearningForPhysics/blob/main/_sources/lectures/GraphNeuralNetworks.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/illinois-ipaml/MachineLearningForPhysics" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/_sources/lectures/GraphNeuralNetworks.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Graph Neural Networks</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Graph Neural Networks</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-introduction-to-graph-data-span"><span style="color:Orange">Introduction to Graph Data</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-graph-classification-span"><span style="color:Orange">Graph Classification</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-exploring-graph-data-with-pytorch-geometric-span"><span style="color:Orange">Exploring graph data with Pytorch Geometric</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-implementing-a-graph-neural-network-span"><span style="color:LightBlue">Implementing a Graph Neural Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-training-the-model-span"><span style="color:LightBlue">Training the model</span></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-deep-sets-span"><span style="color:Orange">Deep Sets</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-data-loader-span"><span style="color:LightBlue">Data Loader</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-deep-sets-network-span"><span style="color:LightBlue">Deep Sets Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-define-the-training-loop-span"><span style="color:LightBlue">Define the training loop</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-define-training-validation-testing-data-generators-span"><span style="color:LightBlue">Define training, validation, testing data generators</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-train-span"><span style="color:LightBlue">Train</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-evaluate-on-test-data-span"><span style="color:LightBlue">Evaluate on Test Data</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightgreen-auc-and-roc-curves-span"><span style="color:LightGreen">AUC and ROC Curves</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-interaction-network-span"><span style="color:Orange">Interaction Network</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-graph-datasets-span"><span style="color:LightBlue">Graph Datasets</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-graph-neural-network-span"><span style="color:LightBlue">Graph Neural Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><span style="color:LightBlue">Define the training loop</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><span style="color:LightBlue">Define training, validation, testing data generators</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><span style="color:LightBlue">Train</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><span style="color:LightBlue">Evaluate on Test Data</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-acknowledgments-span"><span style="color:Orange">Acknowledgments</span></a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="graph-neural-networks">
<h1>Graph Neural Networks<a class="headerlink" href="#graph-neural-networks" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span><span class="p">;</span> <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- allowlist common PyG pickled classes (PyTorch 2.6 safe loading) ----</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_safe_globals</span>
<span class="c1"># Core PyG data classes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataTensorAttr</span><span class="p">,</span> <span class="n">DataEdgeAttr</span>
<span class="c1"># Some installs also use these:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataGraphAttr</span><span class="p">,</span> <span class="n">DataGlobalAttr</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">DataGraphAttr</span> <span class="o">=</span> <span class="n">DataGlobalAttr</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Storages sometimes appear in pickles too:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStorage</span><span class="p">,</span> <span class="n">NodeStorage</span><span class="p">,</span> <span class="n">EdgeStorage</span><span class="p">,</span> <span class="n">GlobalStorage</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">BaseStorage</span> <span class="o">=</span> <span class="n">NodeStorage</span> <span class="o">=</span> <span class="n">EdgeStorage</span> <span class="o">=</span> <span class="n">GlobalStorage</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">allow</span> <span class="o">=</span> <span class="p">[</span><span class="n">Data</span><span class="p">,</span> <span class="n">DataTensorAttr</span><span class="p">,</span> <span class="n">DataEdgeAttr</span><span class="p">,</span> <span class="n">DataGraphAttr</span><span class="p">,</span> <span class="n">DataGlobalAttr</span><span class="p">,</span>
         <span class="n">BaseStorage</span><span class="p">,</span> <span class="n">NodeStorage</span><span class="p">,</span> <span class="n">EdgeStorage</span><span class="p">,</span> <span class="n">GlobalStorage</span><span class="p">]</span>
<span class="n">allow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">allow</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">add_safe_globals</span><span class="p">(</span><span class="n">allow</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TORCH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="c1">#ensure that the PyTorch and the PyG are the same version</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pyvis
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-q<span class="w"> </span>torch-scatter<span class="w"> </span>-f<span class="w"> </span>https://data.pyg.org/whl/torch-<span class="si">${</span><span class="nv">TORCH</span><span class="si">}</span>.html
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-q<span class="w"> </span>torch-sparse<span class="w"> </span>-f<span class="w"> </span>https://data.pyg.org/whl/torch-<span class="si">${</span><span class="nv">TORCH</span><span class="si">}</span>.html
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-q<span class="w"> </span>git+https://github.com/pyg-team/pytorch_geometric.git

<span class="kn">import</span><span class="w"> </span><span class="nn">torch_geometric</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.8.0+cu126
Requirement already satisfied: pyvis in /usr/local/lib/python3.12/dist-packages (0.3.2)
Requirement already satisfied: ipython&gt;=5.3.0 in /usr/local/lib/python3.12/dist-packages (from pyvis) (7.34.0)
Requirement already satisfied: jinja2&gt;=2.9.6 in /usr/local/lib/python3.12/dist-packages (from pyvis) (3.1.6)
Requirement already satisfied: jsonpickle&gt;=1.4.1 in /usr/local/lib/python3.12/dist-packages (from pyvis) (4.1.1)
Requirement already satisfied: networkx&gt;=1.11 in /usr/local/lib/python3.12/dist-packages (from pyvis) (3.5)
Requirement already satisfied: setuptools&gt;=18.5 in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (75.2.0)
Requirement already satisfied: jedi&gt;=0.16 in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (0.19.2)
Requirement already satisfied: decorator in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (4.4.2)
Requirement already satisfied: pickleshare in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (0.7.5)
Requirement already satisfied: traitlets&gt;=4.2 in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (5.7.1)
Requirement already satisfied: prompt-toolkit!=3.0.0,!=3.0.1,&lt;3.1.0,&gt;=2.0.0 in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (3.0.52)
Requirement already satisfied: pygments in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (2.19.2)
Requirement already satisfied: backcall in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (0.2.0)
Requirement already satisfied: matplotlib-inline in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (0.2.1)
Requirement already satisfied: pexpect&gt;4.3 in /usr/local/lib/python3.12/dist-packages (from ipython&gt;=5.3.0-&gt;pyvis) (4.9.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2&gt;=2.9.6-&gt;pyvis) (3.0.3)
Requirement already satisfied: parso&lt;0.9.0,&gt;=0.8.4 in /usr/local/lib/python3.12/dist-packages (from jedi&gt;=0.16-&gt;ipython&gt;=5.3.0-&gt;pyvis) (0.8.5)
Requirement already satisfied: ptyprocess&gt;=0.5 in /usr/local/lib/python3.12/dist-packages (from pexpect&gt;4.3-&gt;ipython&gt;=5.3.0-&gt;pyvis) (0.7.0)
Requirement already satisfied: wcwidth in /usr/local/lib/python3.12/dist-packages (from prompt-toolkit!=3.0.0,!=3.0.1,&lt;3.1.0,&gt;=2.0.0-&gt;ipython&gt;=5.3.0-&gt;pyvis) (0.2.14)
  Installing build dependencies ... ?25l?25hdone
  Getting requirements to build wheel ... ?25l?25hdone
  Preparing metadata (pyproject.toml) ... ?25l?25hdone
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="span-style-color-orange-introduction-to-graph-data-span">
<h1><span style="color:Orange">Introduction to Graph Data</span><a class="headerlink" href="#span-style-color-orange-introduction-to-graph-data-span" title="Permalink to this heading">#</a></h1>
<p>Graphs can be seen as a system or language for modeling systems that are complex and linked together.
A graph is a data type that is modelled as a set of objects which can be represented as a node or vertex and their relationships which is called edges. A graph data can also be seen as a network data where there are points connected together.</p>
<p>A <span style="color:Violet">node</span> (vertex) of a graph is point in a graph while an <span style="color:Violet">edge</span> is a component that joins edges together in a graph. Graphs can be used to represent data from a lot of domains like biology, physics, social science, chemistry and others.</p>
<div>
<img src="https://raw.githubusercontent.com/illinois-ipaml/MachineLearningForPhysics/main/img/GraphNeuralNetworks-GraphExample.jpeg" width=800></img>
</div></section>
<section class="tex2jax_ignore mathjax_ignore" id="span-style-color-orange-graph-classification-span">
<h1><span style="color:Orange">Graph Classification</span><a class="headerlink" href="#span-style-color-orange-graph-classification-span" title="Permalink to this heading">#</a></h1>
<p>Graphs can be classified into different categories <span style="color:Violet">directed/undirected graphs</span>, <span style="color:Violet">weighted/binary graphs</span> and <span style="color:Violet">homogenous/heterogenous graphs</span>.</p>
<ul class="simple">
<li><p><span style="color:Violet">Directed/Undirected graphs</span>: Directed graphs are the ones that all the edges have directtions while in undirected graphs, the edges are does not have directions</p></li>
<li><p><span style="color:Violet">Weighted/Binary graphs</span>: Weighted graphs is a type of graph that each of the edges are assigned with a value while binary graphs are the ones that the edges does not have an assigned value.</p></li>
<li><p><span style="color:Violet">Homogenous/Heterogenous graphs</span>: Homogenous graphs are the ones that all the nodes and/or edges are of the same type (e.g. friendship graph) while heterogenous graphs are graphs where the nodes and/or edges are of different types (e.g. knowledge graph).</p></li>
</ul>
<p>Traditional graph analysis methods requires using searching algorithms, clustering spanning tree algorithms and so on. A major downside to using these methods for analysis of graph data is that you require a prior knowledge of the graph to be able to apply these algorithms.</p>
<p>Based on the structure of the graph data, traditional machine learning system will not be able to properly interprete the graph data and thus the advent of the <span style="color:Violet">Graph Neural Network</span> (GNN). Graph neural network is a domain of deep learning that is mostly concerned with deep learning operations on graph datasets.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="span-style-color-orange-exploring-graph-data-with-pytorch-geometric-span">
<h1><span style="color:Orange">Exploring graph data with Pytorch Geometric</span><a class="headerlink" href="#span-style-color-orange-exploring-graph-data-with-pytorch-geometric-span" title="Permalink to this heading">#</a></h1>
<p>Now we will explore graph and graph neural networks using the PyTorch Geometric (PyG) package (already loaded)</p>
<p>Letâ€™s create a function that will help us visualize a graph data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">node_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Set2&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>PyG provides access to a couple of graph datasets. For this notebook, we are going to use <a class="reference external" href="https://en.wikipedia.org/wiki/Zachary%27s_karate_club">Zacharyâ€™s karate club</a> network <a class="reference external" href="https://karateclub.readthedocs.io/en/latest/modules/dataset.html">dataset</a>.</p>
<p>Zacharyâ€™s karate club is a great example of social relationships within a small group. This set of data indicated the interactions of club members outside of the club. This dataset also documented the conflict between the instructor, Mr.Hi, and the club president, John because of course price. In the end, half of the members formed a new club around Mr.Hi, and the other half either stayed at the old karate club or gave up karate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">KarateClub</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">KarateClub</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have imported a graph dataset, letâ€™s look at some of the properties of a graph dataset. We will look at some of the properties at the level of the dataset and then select a graph in the dataset to explore itâ€™s properties.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset properties&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dataset: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#This prints the name of the dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of graphs in the dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of features: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Number of features each node in the dataset has</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of classes: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Number of classes that a node can be classified into</span>

<span class="c1"># Since we have one graph in the dataset, we will select the graph and explore it&#39;s properties</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Graph properties&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>

<span class="c1"># Gather some statistics about the graph.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of nodes: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Number of nodes in the graph</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of edges: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">num_edges</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Number of edges in the graph</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average node degree: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">num_edges</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Average number of nodes in the graph</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contains isolated nodes: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">has_isolated_nodes</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Does the graph contains nodes that are not connected</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contains self-loops: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">has_self_loops</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Does the graph contains nodes that are linked to themselves</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Is undirected: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">is_undirected</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#Is the graph an undirected graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset properties
==============================================================
Dataset: KarateClub()
Number of graphs in the dataset: 1
Number of features: 34
Number of classes: 4
Graph properties
==============================================================
Number of nodes: 34
Number of edges: 156
Average node degree: 4.59
Contains isolated nodes: False
Contains self-loops: False
Is undirected: True
</pre></div>
</div>
</div>
</div>
<p>Now letâ€™s visualize the graph using the function that we created earlier. But first, we will convert the graph to <code class="docutils literal notranslate"><span class="pre">networkx</span></code> graph</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_networkx</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">to_networkx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">to_undirected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">visualize_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fa1ce54f5c50e859ebf095af0512666068a20bd832f7b797f8ba7621ff9ea292.png" src="../../_images/fa1ce54f5c50e859ebf095af0512666068a20bd832f7b797f8ba7621ff9ea292.png" />
</div>
</div>
<p>Another way to visualize graph is using <code class="docutils literal notranslate"><span class="pre">pyvis</span></code>. You may download (if on Google Colab) and open the generated <code class="docutils literal notranslate"><span class="pre">nx.html</span></code> file from your local browser.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">)):</span>
    <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># assign the class label to the node. class label has to be int.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyvis.network</span><span class="w"> </span><span class="kn">import</span> <span class="n">Network</span>
<span class="n">vis</span><span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="n">notebook</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cdn_resources</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">barnes_hut</span><span class="p">(</span><span class="n">spring_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">spring_strength</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">from_nx</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
<span class="n">vis</span><span class="o">.</span><span class="n">show_buttons</span><span class="p">(</span><span class="n">filter_</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;physics&quot;</span><span class="p">])</span>
<span class="n">vis</span><span class="o">.</span><span class="n">save_graph</span><span class="p">(</span><span class="s1">&#39;nx.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you run this file locally, you can directly call</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!open nx.html</span>
</pre></div>
</div>
</div>
</div>
<section id="span-style-color-lightblue-implementing-a-graph-neural-network-span">
<h2><span style="color:LightBlue">Implementing a Graph Neural Network</span><a class="headerlink" href="#span-style-color-lightblue-implementing-a-graph-neural-network-span" title="Permalink to this heading">#</a></h2>
<p>For this notebook, we will use a simple GNN which is the <a class="reference external" href="https://towardsdatascience.com/graph-convolutional-networks-introduction-to-gnns-24b3f60d6c95">Graph Convolution Network</a> (GCN) layer.</p>
<ul class="simple">
<li><p>GCN is a specific type of GNN that uses convolutional operations to propagate information between nodes in a graph.</p></li>
<li><p>GCNs leverage a localized aggregation of neighboring node features to update the representations of the nodes.</p></li>
<li><p>GCNs are based on the convolutional operation commonly used in image processing, adapted to the graph domain.</p></li>
<li><p>The layers in a GCN typically apply a graph convolution operation followed by non-linear activation functions.</p></li>
<li><p>GCNs have been successful in tasks such as node classification, where nodes are labeled based on their features and graph structure.</p></li>
</ul>
<p>Our GNN is defined by stacking three graph convolution layers, which corresponds to aggregating 3-hop neighborhood information around each node (all nodes up to 3 â€œhopsâ€ away). In addition, the GCNConv layers reduce the node feature dimensionality to 2, i.e., <code class="docutils literal notranslate"><span class="pre">34â†’4â†’4â†’2</span></code>. Each GCNConv layer is enhanced by a <code class="docutils literal notranslate"><span class="pre">tanh</span></code> non-linearity. We then apply a linear layer which acts as a classifier to map the nodes to 1 out of the 4 possible classes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">GCNConv</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GCN</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GCN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">GCNConv</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_features</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">GCNConv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">GCNConv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tanh</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tanh</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tanh</span><span class="p">()</span>  <span class="c1"># Final GNN embedding space.</span>

        <span class="c1"># Apply a final (linear) classifier.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">h</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">GCN</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GCN(
  (conv1): GCNConv(34, 4)
  (conv2): GCNConv(4, 4)
  (conv3): GCNConv(4, 2)
  (classifier): Linear(in_features=2, out_features=4, bias=True)
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-training-the-model-span">
<h2><span style="color:LightBlue">Training the model</span><a class="headerlink" href="#span-style-color-lightblue-training-the-model-span" title="Permalink to this heading">#</a></h2>
<p>To train the network, we will use the <span style="color:Violet">CrossEntropyLoss</span> for the loss function and <span style="color:Violet">Adam</span> as the gradient optimizer</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">GCN</span><span class="p">()</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>  <span class="c1">#Initialize the CrossEntropyLoss function.</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Initialize the Adam optimizer.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>  <span class="c1"># Clear gradients.</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">)</span>  <span class="c1"># Perform a single forward pass.</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">train_mask</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">train_mask</span><span class="p">])</span>  <span class="c1"># Compute the loss solely based on the training nodes.</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>  <span class="c1"># Derive gradients.</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># Update parameters based on gradients.</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">h</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">401</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0, Loss: 1.414404273033142
Epoch: 1, Loss: 1.4079036712646484
Epoch: 2, Loss: 1.4017865657806396
Epoch: 3, Loss: 1.3959276676177979
Epoch: 4, Loss: 1.3902204036712646
Epoch: 5, Loss: 1.3845514059066772
Epoch: 6, Loss: 1.3788156509399414
Epoch: 7, Loss: 1.372924566268921
Epoch: 8, Loss: 1.3668041229248047
Epoch: 9, Loss: 1.3603920936584473
Epoch: 10, Loss: 1.3536320924758911
Epoch: 11, Loss: 1.346463680267334
Epoch: 12, Loss: 1.3388220071792603
Epoch: 13, Loss: 1.3306517601013184
Epoch: 14, Loss: 1.321907877922058
Epoch: 15, Loss: 1.312545895576477
Epoch: 16, Loss: 1.3025131225585938
Epoch: 17, Loss: 1.2917399406433105
Epoch: 18, Loss: 1.2801498174667358
Epoch: 19, Loss: 1.267681360244751
Epoch: 20, Loss: 1.2542929649353027
Epoch: 21, Loss: 1.2399559020996094
Epoch: 22, Loss: 1.2246456146240234
Epoch: 23, Loss: 1.2083479166030884
Epoch: 24, Loss: 1.1910829544067383
Epoch: 25, Loss: 1.172907829284668
Epoch: 26, Loss: 1.1538856029510498
Epoch: 27, Loss: 1.1340937614440918
Epoch: 28, Loss: 1.113678216934204
Epoch: 29, Loss: 1.092814564704895
Epoch: 30, Loss: 1.0716636180877686
Epoch: 31, Loss: 1.0504320859909058
Epoch: 32, Loss: 1.0293234586715698
Epoch: 33, Loss: 1.0085136890411377
Epoch: 34, Loss: 0.9882093071937561
Epoch: 35, Loss: 0.9685617685317993
Epoch: 36, Loss: 0.9497098922729492
Epoch: 37, Loss: 0.9317660331726074
Epoch: 38, Loss: 0.914797306060791
Epoch: 39, Loss: 0.8988678455352783
Epoch: 40, Loss: 0.8839972019195557
Epoch: 41, Loss: 0.8701906800270081
Epoch: 42, Loss: 0.8574356436729431
Epoch: 43, Loss: 0.8456954956054688
Epoch: 44, Loss: 0.8349325060844421
Epoch: 45, Loss: 0.8250938057899475
Epoch: 46, Loss: 0.8161189556121826
Epoch: 47, Loss: 0.8079493045806885
Epoch: 48, Loss: 0.800520658493042
Epoch: 49, Loss: 0.7937697172164917
Epoch: 50, Loss: 0.7876370549201965
Epoch: 51, Loss: 0.7820646166801453
Epoch: 52, Loss: 0.7769969701766968
Epoch: 53, Loss: 0.772383451461792
Epoch: 54, Loss: 0.7681777477264404
Epoch: 55, Loss: 0.7643368244171143
Epoch: 56, Loss: 0.7608218789100647
Epoch: 57, Loss: 0.7575987577438354
Epoch: 58, Loss: 0.7546370029449463
Epoch: 59, Loss: 0.7519097924232483
Epoch: 60, Loss: 0.7493933439254761
Epoch: 61, Loss: 0.7470666766166687
Epoch: 62, Loss: 0.7449116706848145
Epoch: 63, Loss: 0.7429124116897583
Epoch: 64, Loss: 0.741054356098175
Epoch: 65, Loss: 0.7393250465393066
Epoch: 66, Loss: 0.737712562084198
Epoch: 67, Loss: 0.7362066507339478
Epoch: 68, Loss: 0.734798014163971
Epoch: 69, Loss: 0.7334780097007751
Epoch: 70, Loss: 0.7322387099266052
Epoch: 71, Loss: 0.7310730814933777
Epoch: 72, Loss: 0.7299746870994568
Epoch: 73, Loss: 0.7289378643035889
Epoch: 74, Loss: 0.7279574275016785
Epoch: 75, Loss: 0.7270289659500122
Epoch: 76, Loss: 0.7261483669281006
Epoch: 77, Loss: 0.7253117561340332
Epoch: 78, Loss: 0.7245160937309265
Epoch: 79, Loss: 0.7237581014633179
Epoch: 80, Loss: 0.7230353355407715
Epoch: 81, Loss: 0.7223450541496277
Epoch: 82, Loss: 0.7216847538948059
Epoch: 83, Loss: 0.7210525274276733
Epoch: 84, Loss: 0.7204460501670837
Epoch: 85, Loss: 0.7198634147644043
Epoch: 86, Loss: 0.7193031311035156
Epoch: 87, Loss: 0.7187634110450745
Epoch: 88, Loss: 0.7182430028915405
Epoch: 89, Loss: 0.7177404165267944
Epoch: 90, Loss: 0.7172542810440063
Epoch: 91, Loss: 0.7167837619781494
Epoch: 92, Loss: 0.7163279056549072
Epoch: 93, Loss: 0.7158852815628052
Epoch: 94, Loss: 0.7154552340507507
Epoch: 95, Loss: 0.7150366902351379
Epoch: 96, Loss: 0.7146288156509399
Epoch: 97, Loss: 0.7142307758331299
Epoch: 98, Loss: 0.7138415575027466
Epoch: 99, Loss: 0.713460385799408
Epoch: 100, Loss: 0.7130865454673767
Epoch: 101, Loss: 0.7127190232276917
Epoch: 102, Loss: 0.7123571634292603
Epoch: 103, Loss: 0.7120001316070557
Epoch: 104, Loss: 0.7116469144821167
Epoch: 105, Loss: 0.7112967371940613
Epoch: 106, Loss: 0.7109485864639282
Epoch: 107, Loss: 0.7106014490127563
Epoch: 108, Loss: 0.7102540731430054
Epoch: 109, Loss: 0.7099055051803589
Epoch: 110, Loss: 0.7095539569854736
Epoch: 111, Loss: 0.7091981172561646
Epoch: 112, Loss: 0.7088361978530884
Epoch: 113, Loss: 0.7084662318229675
Epoch: 114, Loss: 0.708085834980011
Epoch: 115, Loss: 0.7076926827430725
Epoch: 116, Loss: 0.7072840929031372
Epoch: 117, Loss: 0.7068566679954529
Epoch: 118, Loss: 0.7064076662063599
Epoch: 119, Loss: 0.7059328556060791
Epoch: 120, Loss: 0.7054286599159241
Epoch: 121, Loss: 0.7048909664154053
Epoch: 122, Loss: 0.7043149471282959
Epoch: 123, Loss: 0.7036959528923035
Epoch: 124, Loss: 0.7030287981033325
Epoch: 125, Loss: 0.702308177947998
Epoch: 126, Loss: 0.7015290260314941
Epoch: 127, Loss: 0.7006871104240417
Epoch: 128, Loss: 0.6997777223587036
Epoch: 129, Loss: 0.6987966895103455
Epoch: 130, Loss: 0.6977396011352539
Epoch: 131, Loss: 0.696602463722229
Epoch: 132, Loss: 0.695381760597229
Epoch: 133, Loss: 0.6940731406211853
Epoch: 134, Loss: 0.6926735639572144
Epoch: 135, Loss: 0.6911810636520386
Epoch: 136, Loss: 0.6895936131477356
Epoch: 137, Loss: 0.6879096031188965
Epoch: 138, Loss: 0.6861275434494019
Epoch: 139, Loss: 0.6842458844184875
Epoch: 140, Loss: 0.6822647452354431
Epoch: 141, Loss: 0.6801841259002686
Epoch: 142, Loss: 0.678005039691925
Epoch: 143, Loss: 0.6757267713546753
Epoch: 144, Loss: 0.6733517050743103
Epoch: 145, Loss: 0.670880913734436
Epoch: 146, Loss: 0.6683160066604614
Epoch: 147, Loss: 0.6656591892242432
Epoch: 148, Loss: 0.662912905216217
Epoch: 149, Loss: 0.6600790023803711
Epoch: 150, Loss: 0.6571605205535889
Epoch: 151, Loss: 0.6541600227355957
Epoch: 152, Loss: 0.6510804891586304
Epoch: 153, Loss: 0.6479246020317078
Epoch: 154, Loss: 0.6446951627731323
Epoch: 155, Loss: 0.6413953304290771
Epoch: 156, Loss: 0.6380279064178467
Epoch: 157, Loss: 0.6346004009246826
Epoch: 158, Loss: 0.6311675906181335
Epoch: 159, Loss: 0.6280733942985535
Epoch: 160, Loss: 0.624741792678833
Epoch: 161, Loss: 0.6204181909561157
Epoch: 162, Loss: 0.6175937056541443
Epoch: 163, Loss: 0.6130720973014832
Epoch: 164, Loss: 0.6099883913993835
Epoch: 165, Loss: 0.605615496635437
Epoch: 166, Loss: 0.6024593114852905
Epoch: 167, Loss: 0.5980789661407471
Epoch: 168, Loss: 0.5947373509407043
Epoch: 169, Loss: 0.5904757976531982
Epoch: 170, Loss: 0.5870139002799988
Epoch: 171, Loss: 0.5828227400779724
Epoch: 172, Loss: 0.57918781042099
Epoch: 173, Loss: 0.5751644968986511
Epoch: 174, Loss: 0.5713582634925842
Epoch: 175, Loss: 0.5674843788146973
Epoch: 176, Loss: 0.5635409951210022
Epoch: 177, Loss: 0.5597835183143616
Epoch: 178, Loss: 0.5557851791381836
Epoch: 179, Loss: 0.5520824193954468
Epoch: 180, Loss: 0.5481283068656921
Epoch: 181, Loss: 0.5443798303604126
Epoch: 182, Loss: 0.5405674576759338
Epoch: 183, Loss: 0.536763608455658
Epoch: 184, Loss: 0.5330840349197388
Epoch: 185, Loss: 0.5293052792549133
Epoch: 186, Loss: 0.5256624221801758
Epoch: 187, Loss: 0.5220221281051636
Epoch: 188, Loss: 0.5183925628662109
Epoch: 189, Loss: 0.5148743987083435
Epoch: 190, Loss: 0.5113505721092224
Epoch: 191, Loss: 0.5078819394111633
Epoch: 192, Loss: 0.5045009851455688
Epoch: 193, Loss: 0.501140832901001
Epoch: 194, Loss: 0.4978431463241577
Epoch: 195, Loss: 0.4946272373199463
Epoch: 196, Loss: 0.4914534091949463
Epoch: 197, Loss: 0.48833614587783813
Epoch: 198, Loss: 0.4852977991104126
Epoch: 199, Loss: 0.48231884837150574
Epoch: 200, Loss: 0.4793927073478699
Epoch: 201, Loss: 0.4765353202819824
Epoch: 202, Loss: 0.47374656796455383
Epoch: 203, Loss: 0.4710150361061096
Epoch: 204, Loss: 0.4683414101600647
Epoch: 205, Loss: 0.4657326340675354
Epoch: 206, Loss: 0.4631871283054352
Epoch: 207, Loss: 0.4606988728046417
Epoch: 208, Loss: 0.4582675099372864
Epoch: 209, Loss: 0.455896258354187
Epoch: 210, Loss: 0.4535853862762451
Epoch: 211, Loss: 0.4513319730758667
Epoch: 212, Loss: 0.4491341710090637
Epoch: 213, Loss: 0.4469926953315735
Epoch: 214, Loss: 0.4449084997177124
Epoch: 215, Loss: 0.4428805708885193
Epoch: 216, Loss: 0.4409070909023285
Epoch: 217, Loss: 0.4389870762825012
Epoch: 218, Loss: 0.4371201694011688
Epoch: 219, Loss: 0.4353058934211731
Epoch: 220, Loss: 0.43354323506355286
Epoch: 221, Loss: 0.43183043599128723
Epoch: 222, Loss: 0.43016624450683594
Epoch: 223, Loss: 0.4285491704940796
Epoch: 224, Loss: 0.42697858810424805
Epoch: 225, Loss: 0.4254530072212219
Epoch: 226, Loss: 0.4239709973335266
Epoch: 227, Loss: 0.4225310981273651
Epoch: 228, Loss: 0.4211316406726837
Epoch: 229, Loss: 0.41977155208587646
Epoch: 230, Loss: 0.4184495508670807
Epoch: 231, Loss: 0.4171642065048218
Epoch: 232, Loss: 0.41591423749923706
Epoch: 233, Loss: 0.4146982431411743
Epoch: 234, Loss: 0.41351497173309326
Epoch: 235, Loss: 0.41236311197280884
Epoch: 236, Loss: 0.41124171018600464
Epoch: 237, Loss: 0.41014939546585083
Epoch: 238, Loss: 0.40908509492874146
Epoch: 239, Loss: 0.4080478250980377
Epoch: 240, Loss: 0.40703630447387695
Epoch: 241, Loss: 0.4060494601726532
Epoch: 242, Loss: 0.4050863981246948
Epoch: 243, Loss: 0.4041459858417511
Epoch: 244, Loss: 0.40322715044021606
Epoch: 245, Loss: 0.40232914686203003
Epoch: 246, Loss: 0.4014507532119751
Epoch: 247, Loss: 0.4005908966064453
Epoch: 248, Loss: 0.3997487425804138
Epoch: 249, Loss: 0.3989231586456299
Epoch: 250, Loss: 0.3981132507324219
Epoch: 251, Loss: 0.3973178267478943
Epoch: 252, Loss: 0.3965359330177307
Epoch: 253, Loss: 0.39576637744903564
Epoch: 254, Loss: 0.3950079679489136
Epoch: 255, Loss: 0.39425957202911377
Epoch: 256, Loss: 0.39351972937583923
Epoch: 257, Loss: 0.3927870988845825
Epoch: 258, Loss: 0.39206016063690186
Epoch: 259, Loss: 0.3913372755050659
Epoch: 260, Loss: 0.39061659574508667
Epoch: 261, Loss: 0.38989609479904175
Epoch: 262, Loss: 0.3891735076904297
Epoch: 263, Loss: 0.3884465992450714
Epoch: 264, Loss: 0.3877125382423401
Epoch: 265, Loss: 0.386968731880188
Epoch: 266, Loss: 0.3862120509147644
Epoch: 267, Loss: 0.3854394555091858
Epoch: 268, Loss: 0.3846479058265686
Epoch: 269, Loss: 0.3838343024253845
Epoch: 270, Loss: 0.3829955458641052
Epoch: 271, Loss: 0.3821285367012024
Epoch: 272, Loss: 0.38122984766960144
Epoch: 273, Loss: 0.3802953362464905
Epoch: 274, Loss: 0.3793206214904785
Epoch: 275, Loss: 0.3783016800880432
Epoch: 276, Loss: 0.3772349953651428
Epoch: 277, Loss: 0.37611788511276245
Epoch: 278, Loss: 0.37494710087776184
Epoch: 279, Loss: 0.3737183213233948
Epoch: 280, Loss: 0.3724270462989807
Epoch: 281, Loss: 0.37107014656066895
Epoch: 282, Loss: 0.3696446418762207
Epoch: 283, Loss: 0.36814606189727783
Epoch: 284, Loss: 0.36657047271728516
Epoch: 285, Loss: 0.36491692066192627
Epoch: 286, Loss: 0.36318403482437134
Epoch: 287, Loss: 0.3613690733909607
Epoch: 288, Loss: 0.35947176814079285
Epoch: 289, Loss: 0.35749131441116333
Epoch: 290, Loss: 0.35542571544647217
Epoch: 291, Loss: 0.35327696800231934
Epoch: 292, Loss: 0.35104548931121826
Epoch: 293, Loss: 0.348732590675354
Epoch: 294, Loss: 0.3463401198387146
Epoch: 295, Loss: 0.3438689708709717
Epoch: 296, Loss: 0.3413234353065491
Epoch: 297, Loss: 0.3387056589126587
Epoch: 298, Loss: 0.3360198438167572
Epoch: 299, Loss: 0.3332687020301819
Epoch: 300, Loss: 0.3304575979709625
Epoch: 301, Loss: 0.3275911211967468
Epoch: 302, Loss: 0.32467323541641235
Epoch: 303, Loss: 0.3217102289199829
Epoch: 304, Loss: 0.31870734691619873
Epoch: 305, Loss: 0.3156694173812866
Epoch: 306, Loss: 0.3126032054424286
Epoch: 307, Loss: 0.309514582157135
Epoch: 308, Loss: 0.30640894174575806
Epoch: 309, Loss: 0.3032926321029663
Epoch: 310, Loss: 0.3001711368560791
Epoch: 311, Loss: 0.2970510721206665
Epoch: 312, Loss: 0.2939380407333374
Epoch: 313, Loss: 0.29083994030952454
Epoch: 314, Loss: 0.28777000308036804
Epoch: 315, Loss: 0.2847808003425598
Epoch: 316, Loss: 0.28215885162353516
Epoch: 317, Loss: 0.28068214654922485
Epoch: 318, Loss: 0.281310498714447
Epoch: 319, Loss: 0.2728884816169739
Epoch: 320, Loss: 0.2745310068130493
Epoch: 321, Loss: 0.2720831334590912
Epoch: 322, Loss: 0.26696065068244934
Epoch: 323, Loss: 0.26664233207702637
Epoch: 324, Loss: 0.2592766284942627
Epoch: 325, Loss: 0.2601472735404968
Epoch: 326, Loss: 0.2545285224914551
Epoch: 327, Loss: 0.25481849908828735
Epoch: 328, Loss: 0.24915021657943726
Epoch: 329, Loss: 0.24911433458328247
Epoch: 330, Loss: 0.2446850836277008
Epoch: 331, Loss: 0.24411651492118835
Epoch: 332, Loss: 0.23997142910957336
Epoch: 333, Loss: 0.23917514085769653
Epoch: 334, Loss: 0.23577666282653809
Epoch: 335, Loss: 0.23464486002922058
Epoch: 336, Loss: 0.23151439428329468
Epoch: 337, Loss: 0.23031237721443176
Epoch: 338, Loss: 0.22759047150611877
Epoch: 339, Loss: 0.2262641340494156
Epoch: 340, Loss: 0.22371076047420502
Epoch: 341, Loss: 0.22240403294563293
Epoch: 342, Loss: 0.22006937861442566
Epoch: 343, Loss: 0.21875375509262085
Epoch: 344, Loss: 0.21651752293109894
Epoch: 345, Loss: 0.21524083614349365
Epoch: 346, Loss: 0.21314159035682678
Epoch: 347, Loss: 0.2118893563747406
Epoch: 348, Loss: 0.2098742127418518
Epoch: 349, Loss: 0.2086487114429474
Epoch: 350, Loss: 0.20675000548362732
Epoch: 351, Loss: 0.20554596185684204
Epoch: 352, Loss: 0.20373961329460144
Epoch: 353, Loss: 0.20253847539424896
Epoch: 354, Loss: 0.2008407562971115
Epoch: 355, Loss: 0.19963979721069336
Epoch: 356, Loss: 0.19804327189922333
Epoch: 357, Loss: 0.19682352244853973
Epoch: 358, Loss: 0.19533777236938477
Epoch: 359, Loss: 0.1941000521183014
Epoch: 360, Loss: 0.1927233636379242
Epoch: 361, Loss: 0.19146054983139038
Epoch: 362, Loss: 0.19018548727035522
Epoch: 363, Loss: 0.18890555202960968
Epoch: 364, Loss: 0.18771356344223022
Epoch: 365, Loss: 0.18643513321876526
Epoch: 366, Loss: 0.18530058860778809
Epoch: 367, Loss: 0.18404754996299744
Epoch: 368, Loss: 0.18294145166873932
Epoch: 369, Loss: 0.18173813819885254
Epoch: 370, Loss: 0.18063880503177643
Epoch: 371, Loss: 0.17949628829956055
Epoch: 372, Loss: 0.17839354276657104
Epoch: 373, Loss: 0.17731067538261414
Epoch: 374, Loss: 0.17621111869812012
Epoch: 375, Loss: 0.17517279088497162
Epoch: 376, Loss: 0.1740933060646057
Epoch: 377, Loss: 0.17307883501052856
Epoch: 378, Loss: 0.1720350980758667
Epoch: 379, Loss: 0.17102889716625214
Epoch: 380, Loss: 0.1700274646282196
Epoch: 381, Loss: 0.1690284162759781
Epoch: 382, Loss: 0.16806191205978394
Epoch: 383, Loss: 0.1670800745487213
Epoch: 384, Loss: 0.16613435745239258
Epoch: 385, Loss: 0.16518042981624603
Epoch: 386, Loss: 0.16424556076526642
Epoch: 387, Loss: 0.16332244873046875
Epoch: 388, Loss: 0.16239938139915466
Epoch: 389, Loss: 0.16150003671646118
Epoch: 390, Loss: 0.16059638559818268
Epoch: 391, Loss: 0.15971145033836365
Epoch: 392, Loss: 0.15883231163024902
Epoch: 393, Loss: 0.1579589545726776
Epoch: 394, Loss: 0.15710149705410004
Epoch: 395, Loss: 0.15624426305294037
Epoch: 396, Loss: 0.15540176630020142
Epoch: 397, Loss: 0.154564768075943
Epoch: 398, Loss: 0.15373441576957703
Epoch: 399, Loss: 0.1529160439968109
Epoch: 400, Loss: 0.1521005928516388
</pre></div>
</div>
</div>
</div>
<p>There is much more analysis that can be done with GNNs on the Karate Club dataseet. See <a class="reference external" href="https://www.linkedin.com/pulse/community-detection-social-networks-case-study-zacharys-marin/">here</a> for examples. Our goal in this lecture was to use it an way to introduce the implementation and use of GNNs within the Pytorch framework.</p>
<p>We will now turn to examples using simulated open data from the CMS experiment at the LHC.  The algorithmsâ€™ inputs are features of the reconstructed charged particles in a jet and the secondary vertices associated with them. Describing the jet shower as a combination of particle-to-particle and particle-to-vertex interactions, the model is trained to learn a jet representation on which the classification problem isoptimized.</p>
<p>We show below an example using a community model called â€œDeepSetsâ€ and then compare to an Interaction Model GNN.</p>
</section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="span-style-color-orange-deep-sets-span">
<h1><span style="color:Orange">Deep Sets</span><a class="headerlink" href="#span-style-color-orange-deep-sets-span" title="Permalink to this heading">#</a></h1>
<p>We will start by looking at Deep Sets networks using PyTorch. The architecture is based on the following paper: <a class="reference external" href="https://papers.nips.cc/paper/2017/file/f22e4747da1aa27e363d86d40ff442fe-Paper.pdf">DeepSets</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>wget
<span class="kn">import</span><span class="w"> </span><span class="nn">wget</span>

<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>PyYAML
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>uproot
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>awkward
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>mplhep
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: wget in /usr/local/lib/python3.12/dist-packages (3.2)
Requirement already satisfied: PyYAML in /usr/local/lib/python3.12/dist-packages (6.0.3)
Requirement already satisfied: uproot in /usr/local/lib/python3.12/dist-packages (5.6.8)
Requirement already satisfied: awkward&gt;=2.8.2 in /usr/local/lib/python3.12/dist-packages (from uproot) (2.8.10)
Requirement already satisfied: cramjam&gt;=2.5.0 in /usr/local/lib/python3.12/dist-packages (from uproot) (2.11.0)
Requirement already satisfied: fsspec!=2025.7.0 in /usr/local/lib/python3.12/dist-packages (from uproot) (2025.3.0)
Requirement already satisfied: numpy in /usr/local/lib/python3.12/dist-packages (from uproot) (2.0.2)
Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from uproot) (25.0)
Requirement already satisfied: xxhash in /usr/local/lib/python3.12/dist-packages (from uproot) (3.6.0)
Requirement already satisfied: awkward-cpp==50 in /usr/local/lib/python3.12/dist-packages (from awkward&gt;=2.8.2-&gt;uproot) (50)
Requirement already satisfied: awkward in /usr/local/lib/python3.12/dist-packages (2.8.10)
Requirement already satisfied: awkward-cpp==50 in /usr/local/lib/python3.12/dist-packages (from awkward) (50)
Requirement already satisfied: fsspec&gt;=2022.11.0 in /usr/local/lib/python3.12/dist-packages (from awkward) (2025.3.0)
Requirement already satisfied: numpy&gt;=1.18.0 in /usr/local/lib/python3.12/dist-packages (from awkward) (2.0.2)
Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from awkward) (25.0)
Requirement already satisfied: mplhep in /usr/local/lib/python3.12/dist-packages (0.4.1)
Requirement already satisfied: matplotlib&gt;=3.4 in /usr/local/lib/python3.12/dist-packages (from mplhep) (3.10.0)
Requirement already satisfied: mplhep-data&gt;=0.0.4 in /usr/local/lib/python3.12/dist-packages (from mplhep) (0.0.5)
Requirement already satisfied: numpy&gt;=1.16.0 in /usr/local/lib/python3.12/dist-packages (from mplhep) (2.0.2)
Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from mplhep) (25.0)
Requirement already satisfied: uhi&gt;=0.2.0 in /usr/local/lib/python3.12/dist-packages (from mplhep) (1.0.0)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (1.3.3)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (4.60.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (1.4.9)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (11.3.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (3.2.5)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib&gt;=3.4-&gt;mplhep) (2.9.0.post0)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=3.4-&gt;mplhep) (1.17.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="c1"># WGET for colab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;definitions_lorentz.yml&quot;</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/definitions_lorentz.yml&quot;</span>
    <span class="n">definitionsFile</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;definitions_lorentz.yml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="c1"># The FullLoader parameter handles the conversion from YAML</span>
    <span class="c1"># scalar values to Python the dictionary format</span>
    <span class="n">definitions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span>
<span class="n">spectators</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;spectators&quot;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>

<span class="n">nfeatures</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nfeatures&quot;</span><span class="p">]</span>
<span class="n">nspectators</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nspectators&quot;</span><span class="p">]</span>
<span class="n">nlabels</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nlabels&quot;</span><span class="p">]</span>
<span class="n">ntracks</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;ntracks&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="span-style-color-lightblue-data-loader-span">
<h2><span style="color:LightBlue">Data Loader</span><a class="headerlink" href="#span-style-color-lightblue-data-loader-span" title="Permalink to this heading">#</a></h2>
<p>Here we have to define the dataset loader.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If in colab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;GraphDataset.py&quot;</span><span class="p">):</span>
    <span class="n">urlDSD</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/DeepSetsDataset.py&quot;</span>
    <span class="n">DSD</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlDSD</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;utils.py&quot;</span><span class="p">):</span>
    <span class="n">urlUtils</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/utils.py&quot;</span>
    <span class="n">utils</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlUtils</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">DeepSetsDataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepSetsDataset</span>

<span class="c1"># For colab</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;ntuple_merged_90.root&quot;</span><span class="p">):</span>
    <span class="n">urlFILE</span> <span class="o">=</span> <span class="s2">&quot;http://opendata.cern.ch/eos/opendata/cms/datascience/HiggsToBBNtupleProducerTool/HiggsToBBNTuple_HiggsToBB_QCD_RunII_13TeV_MC/train/ntuple_merged_90.root&quot;</span>
    <span class="n">dataFILE</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlFILE</span><span class="p">)</span>
<span class="n">train_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ntuple_merged_90.root&quot;</span><span class="p">]</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">DeepSetsDataset</span><span class="p">(</span>
    <span class="n">features</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">spectators</span><span class="p">,</span>
    <span class="n">start_event</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stop_event</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">npad</span><span class="o">=</span><span class="n">ntracks</span><span class="p">,</span>
    <span class="n">file_names</span><span class="o">=</span><span class="n">train_files</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">train_generator</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

<span class="n">test_generator</span> <span class="o">=</span> <span class="n">DeepSetsDataset</span><span class="p">(</span>
    <span class="n">features</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">spectators</span><span class="p">,</span>
    <span class="n">start_event</span><span class="o">=</span><span class="mi">10001</span><span class="p">,</span>
    <span class="n">stop_event</span><span class="o">=</span><span class="mi">14001</span><span class="p">,</span>
    <span class="n">npad</span><span class="o">=</span><span class="n">ntracks</span><span class="p">,</span>
    <span class="n">file_names</span><span class="o">=</span><span class="n">train_files</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">test_generator</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8a72a1c67b4c46a4aacbe8e951406cca", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "026506b178be4a4db89da32e25b726a7", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="span-style-color-lightblue-deep-sets-network-span">
<h2><span style="color:LightBlue">Deep Sets Network</span><a class="headerlink" href="#span-style-color-lightblue-deep-sets-network-span" title="Permalink to this heading">#</a></h2>
<p>Deep Sets models are designed to be explicitly permutation invariant. At their core they are composed of two networks, <span class="math notranslate nohighlight">\(\phi\)</span> and <span class="math notranslate nohighlight">\(\rho\)</span>, such that the total network <span class="math notranslate nohighlight">\(f\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[ \Large
\begin{align}
    f &amp;= \rho\left(\Sigma_{\mathbf{x}_i\in\mathcal{X}} ~ \phi(\mathbf{x}_i)\right)
\end{align}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span> are the features for the <span class="math notranslate nohighlight">\(i\)</span>-th element in the input sequence <span class="math notranslate nohighlight">\(\mathcal{X}\)</span>.</p>
<p>We will define a DeepSets model that will take as input up to 60 of the tracks (with 48 features) with zero-padding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Sequential</span> <span class="k">as</span> <span class="n">Seq</span><span class="p">,</span>
    <span class="n">Linear</span> <span class="k">as</span> <span class="n">Lin</span><span class="p">,</span>
    <span class="n">ReLU</span><span class="p">,</span>
    <span class="n">BatchNorm1d</span><span class="p">,</span>
    <span class="n">AvgPool1d</span><span class="p">,</span>
    <span class="n">Sigmoid</span><span class="p">,</span>
    <span class="n">Conv1d</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_scatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">scatter_mean</span>

<span class="c1"># ntracks = 60</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">hidden1</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">hidden2</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">hidden3</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">classify1</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeepSets</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeepSets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Conv1d</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">hidden1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden1</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden1</span><span class="p">,</span> <span class="n">hidden2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden2</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden2</span><span class="p">,</span> <span class="n">hidden3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden3</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">hidden3</span><span class="p">,</span> <span class="n">classify1</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">classify1</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">classify1</span><span class="p">,</span> <span class="n">outputs</span><span class="p">),</span>
            <span class="n">Sigmoid</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">scatter_mean</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntracks</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">DeepSets</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">({</span><span class="n">l</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()})</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">DeepSets</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeepSets(
  (phi): Sequential(
    (0): Conv1d(6, 64, kernel_size=(1,), stride=(1,))
    (1): BatchNorm1d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
    (3): Conv1d(64, 32, kernel_size=(1,), stride=(1,))
    (4): BatchNorm1d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (5): ReLU()
    (6): Conv1d(32, 16, kernel_size=(1,), stride=(1,))
    (7): BatchNorm1d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (8): ReLU()
  )
  (rho): Sequential(
    (0): Linear(in_features=16, out_features=50, bias=True)
    (1): BatchNorm1d(50, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
    (3): Linear(in_features=50, out_features=2, bias=True)
    (4): Sigmoid()
  )
)
----------
{&#39;phi.0.weight&#39;: torch.Size([64, 6, 1]), &#39;phi.0.bias&#39;: torch.Size([64]), &#39;phi.1.weight&#39;: torch.Size([64]), &#39;phi.1.bias&#39;: torch.Size([64]), &#39;phi.1.running_mean&#39;: torch.Size([64]), &#39;phi.1.running_var&#39;: torch.Size([64]), &#39;phi.1.num_batches_tracked&#39;: torch.Size([]), &#39;phi.3.weight&#39;: torch.Size([32, 64, 1]), &#39;phi.3.bias&#39;: torch.Size([32]), &#39;phi.4.weight&#39;: torch.Size([32]), &#39;phi.4.bias&#39;: torch.Size([32]), &#39;phi.4.running_mean&#39;: torch.Size([32]), &#39;phi.4.running_var&#39;: torch.Size([32]), &#39;phi.4.num_batches_tracked&#39;: torch.Size([]), &#39;phi.6.weight&#39;: torch.Size([16, 32, 1]), &#39;phi.6.bias&#39;: torch.Size([16]), &#39;phi.7.weight&#39;: torch.Size([16]), &#39;phi.7.bias&#39;: torch.Size([16]), &#39;phi.7.running_mean&#39;: torch.Size([16]), &#39;phi.7.running_var&#39;: torch.Size([16]), &#39;phi.7.num_batches_tracked&#39;: torch.Size([]), &#39;rho.0.weight&#39;: torch.Size([50, 16]), &#39;rho.0.bias&#39;: torch.Size([50]), &#39;rho.1.weight&#39;: torch.Size([50]), &#39;rho.1.bias&#39;: torch.Size([50]), &#39;rho.1.running_mean&#39;: torch.Size([50]), &#39;rho.1.running_var&#39;: torch.Size([50]), &#39;rho.1.num_batches_tracked&#39;: torch.Size([]), &#39;rho.3.weight&#39;: torch.Size([2, 50]), &#39;rho.3.bias&#39;: torch.Size([2])}
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-define-the-training-loop-span">
<h2><span style="color:LightBlue">Define the training loop</span><a class="headerlink" href="#span-style-color-lightblue-define-the-training-loop-span" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">xentropy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="n">leave</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">batch_loss_item</span> <span class="o">=</span> <span class="n">xentropy</span><span class="p">(</span><span class="n">batch_output</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">batch_loss_item</span>
        <span class="n">t</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;loss = </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">batch_loss_item</span><span class="p">))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>  <span class="c1"># to show immediately the update</span>

    <span class="k">return</span> <span class="n">sum_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">xentropy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="n">leave</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">xentropy</span><span class="p">(</span><span class="n">batch_output</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">batch_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">batch_loss_item</span> <span class="o">=</span> <span class="n">batch_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;loss = </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">batch_loss_item</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>  <span class="c1"># to show immediately the update</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">batch_loss_item</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">sum_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-define-training-validation-testing-data-generators-span">
<h2><span style="color:LightBlue">Define training, validation, testing data generators</span><a class="headerlink" href="#span-style-color-lightblue-define-training-validation-testing-data-generators-span" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConcatDataset</span>

<span class="n">train_generator_data</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">train_generator</span><span class="o">.</span><span class="n">datas</span><span class="p">)</span>
<span class="n">test_generator_data</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">test_generator</span><span class="o">.</span><span class="n">datas</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">random_split</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">valid_frac</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">train_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_generator_data</span><span class="p">)</span>
<span class="n">valid_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_frac</span> <span class="o">*</span> <span class="n">train_length</span><span class="p">)</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span>
    <span class="n">train_generator_data</span><span class="p">,</span> <span class="p">[</span><span class="n">train_length</span> <span class="o">-</span> <span class="n">valid_num</span><span class="p">,</span> <span class="n">valid_num</span><span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">collate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">Batch</span><span class="o">.</span><span class="n">from_data_list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>


<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># train_loader.collate_fn = collate</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># valid_loader.collate_fn = collate</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_generator_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># test_loader.collate_fn = collate</span>

<span class="n">train_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
<span class="n">valid_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">)</span>
<span class="n">test_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_generator_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_length</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9387
7510
1877
3751
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-train-span">
<h2><span style="color:LightBlue">Train</span><a class="headerlink" href="#span-style-color-lightblue-train-span" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">osp</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">stale_epochs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_valid_loss</span> <span class="o">=</span> <span class="mi">99999</span>
<span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">))</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">train_loader</span><span class="p">,</span>
        <span class="n">train_samples</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">valid_loss</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">valid_loader</span><span class="p">,</span>
        <span class="n">valid_samples</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">{:02d}</span><span class="s2">, Training Loss:   </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           Validation Loss: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">valid_loss</span> <span class="o">&lt;</span> <span class="n">best_valid_loss</span><span class="p">:</span>
        <span class="n">best_valid_loss</span> <span class="o">=</span> <span class="n">valid_loss</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;deepsets_best.pth&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New best model saved to:&quot;</span><span class="p">,</span> <span class="n">modpath</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">modpath</span><span class="p">)</span>
        <span class="n">stale_epochs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stale epoch&quot;</span><span class="p">)</span>
        <span class="n">stale_epochs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">stale_epochs</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Early stopping after </span><span class="si">%i</span><span class="s2"> stale epochs&quot;</span> <span class="o">%</span> <span class="n">patience</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b356e9b73ab3428fb30416cbadf2a60a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1a85a2944ca44985bc249b20404558c5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2a18eaf796bc44a9bdce231306445b94", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 00, Training Loss:   0.4480
           Validation Loss: 0.4487
New best model saved to: deepsets_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4018650d8e3f404da3f284c61669c5ac", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "419e427d7d18443297a6775aa290debe", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 01, Training Loss:   0.4394
           Validation Loss: 0.4576
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e19baa9e8ffc480bb169ffd23ff78036", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "518f11375a82439a88e8b2359ea42d96", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 02, Training Loss:   0.4403
           Validation Loss: 0.4483
New best model saved to: deepsets_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8f5a82e1e6ad47edaf57cdcf4ebad144", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ed50ff1bb0c14b7692aa28588c5a1453", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 03, Training Loss:   0.4391
           Validation Loss: 0.4483
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "85fc415f9a8142c89e775881df3fca47", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b11adcd359cd407489c338a7411c72ae", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 04, Training Loss:   0.4392
           Validation Loss: 0.4597
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f0aa045b7582489d8a4494d3510b6874", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e1abac9dbd1448e1802d6b4bdceb2d5f", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 05, Training Loss:   0.4399
           Validation Loss: 0.4465
New best model saved to: deepsets_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5c86a7a2da22435f9cafc2f7e275bcfa", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "12a65d9d601b4121b6a612b2277ce743", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 06, Training Loss:   0.4390
           Validation Loss: 0.4489
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5ce4771b206240b6b7a3f85f5da3f7bb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b27164020d6f48ac9a15fda3a54c04c4", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 07, Training Loss:   0.4390
           Validation Loss: 0.4434
New best model saved to: deepsets_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d6a585af98384b39a6a16094cefbd382", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1812d19d92d9470ebefba7eb2db5193d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 08, Training Loss:   0.4385
           Validation Loss: 0.4489
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2da99d8f38414b38890f9f60bf902e63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef83d48d3bb949798564db5c7093bc55", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 09, Training Loss:   0.4385
           Validation Loss: 0.4489
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "03d69c374ab749d39bb08dce461f8ee0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f806b80d5f264aa7bb7ce1ef973e7415", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 10, Training Loss:   0.4387
           Validation Loss: 0.4488
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3c3785b357e046869aec18e940665ba4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6a7bcfefaedd493ea2a12cd52b844b1a", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 11, Training Loss:   0.4394
           Validation Loss: 0.4440
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "10dc5c5d22ec472abff91e653c8bab3f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ba846509406547e9a7e8aba19db1fbdc", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 12, Training Loss:   0.4382
           Validation Loss: 0.4458
Stale epoch
Early stopping after 5 stale epochs
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-evaluate-on-test-data-span">
<h2><span style="color:LightBlue">Evaluate on Test Data</span><a class="headerlink" href="#span-style-color-lightblue-evaluate-on-test-data-span" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #In case you need to load the model from a pth file</span>
<span class="c1"># #Trained on 4 vectors (as above in notebook)</span>
<span class="c1"># urlPTH = &quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/deepsets_best_4vec.pth&quot;</span>
<span class="c1"># pthFile = wget.download(urlPTH)</span>
<span class="c1"># model.load_state_dict(torch.load(&quot;deepsets_best_4vec.pth&quot;))</span>
<span class="c1"># #Trained on all possible inputs (a different configuration)</span>
<span class="c1"># urlPTH = &quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/deepsets_best_AllTraining.pth&quot;</span>
<span class="c1"># pthFile = wget.download(urlPTH)</span>
<span class="c1"># model.load_state_dict(torch.load(&quot;deepsets_best_AllTraining.pth&quot;))</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">test_samples</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
<span class="n">y_test_ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_predict_ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">track_pt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">track_pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_predict_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">y_test_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">track_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">track_pt</span><span class="p">)</span>
<span class="n">y_test_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_test_ds</span><span class="p">)</span>
<span class="n">y_predict_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_predict_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f9e0dbb8798e453c93dce8f0df6b6b61", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">track_pt</span><span class="p">[</span><span class="n">y_test_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sig&quot;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">track_pt</span><span class="p">[</span><span class="n">y_test_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bkg&quot;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="../../_images/b44ff480cf16fae4cae51b793110118a5291e2842c5c4f20c229cd4cbdfa2844.png" src="../../_images/b44ff480cf16fae4cae51b793110118a5291e2842c5c4f20c229cd4cbdfa2844.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mplhep</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hep</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">hep</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>
<span class="c1"># create ROC curves</span>
<span class="n">fpr_deepset</span><span class="p">,</span> <span class="n">tpr_deepset</span><span class="p">,</span> <span class="n">threshold_deepset</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_predict_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;deepset_roc.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fpr_deepset</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tpr_deepset</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">threshold_deepset</span><span class="p">)</span>

<span class="c1"># plot ROC curves</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">tpr_deepset</span><span class="p">,</span>
    <span class="n">fpr_deepset</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DeepSet, AUC = </span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr_deepset</span><span class="p">,</span> <span class="n">tpr_deepset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;True positive rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;False positive rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8a2f9b861f262b9ae13608d9e362551a77dc278d761675b562427cabdec2e582.png" src="../../_images/8a2f9b861f262b9ae13608d9e362551a77dc278d761675b562427cabdec2e582.png" />
</div>
</div>
<section id="span-style-color-lightgreen-auc-and-roc-curves-span">
<h3><span style="color:LightGreen">AUC and ROC Curves</span><a class="headerlink" href="#span-style-color-lightgreen-auc-and-roc-curves-span" title="Permalink to this heading">#</a></h3>
<p>To better understand this curve, let define the <span style="color:Violet">confusion matrix</span>:</p>
<div>
<img src="https://raw.githubusercontent.com/illinois-ipaml/MachineLearningForPhysics/main/img/GraphNeuralNetworks-ConfusionMatrix.png" width=400></img>
</div><p><span style="color:Violet">True Positive Rate</span> (TPR) is a synonym for recall/sensitivity and is therefore defined as follows:</p>
<div class="math notranslate nohighlight">
\[ \Large
TPR = \frac{TP}{TP + FN}
\]</div>
<p>TPR tells us what proportion of the positive class got correctly classified. A simple example would be determining what proportion of the actual sick people were correctly detected by the model.</p>
<p><span style="color:Violet">False Negative Rate</span> (FNR) is defined as follows:</p>
<div class="math notranslate nohighlight">
\[ \Large
FNR = \frac{FN}{TP + FN}
\]</div>
<p>FNR tells us what proportion of the positive class got incorrectly classified by the classifier. A higher TPR and a lower FNR are desirable since we want to classify the positive class correctly.</p>
<p><span style="color:Violet">True Negative Rate</span> (TNR) is a synonym for specificity and is defined as follows:</p>
<div class="math notranslate nohighlight">
\[ \Large
TNR = \frac{TN}{TN + FP}
\]</div>
<p>Specificity tells us what proportion of the negative class got correctly classified. Taking the same example as in Sensitivity, Specificity would mean determining the proportion of healthy people who were correctly identified by the model.</p>
<p><span style="color:Violet">False Positive Rate</span> (FPR) is defined as follows:</p>
<div class="math notranslate nohighlight">
\[ \Large
TPR = \frac{FP}{TN + FP}
\]</div>
<p>FPR tells us what proportion of the negative class got incorrectly classified by the classifier. A higher TNR and a lower FPR are desirable since we want to classify the negative class correctly.</p>
<p>A <span style="color:Violet">ROC curve</span> (receiver operating characteristic curve) is a graph showing the performance of a classification model at all classification thresholds. This curve plots two parameters:</p>
<ul class="simple">
<li><p>True Positive Rate</p></li>
<li><p>False Positive Rate</p></li>
</ul>
<p>An ROC curve plots TPR vs. FPR at different classification thresholds. Lowering the classification threshold classifies more items as positive, thus increasing both False Positives and True Positives. The following figure shows a typical ROC curve.</p>
<div>
<img src="https://raw.githubusercontent.com/illinois-ipaml/MachineLearningForPhysics/main/img/GraphNeuralNetworks-ROC.png" width=400></img>
</div><p><span style="color:Violet">AUC</span> stands for â€œArea under the ROC Curve.â€ That is, AUC measures the entire two-dimensional area underneath the entire ROC curve (think integral calculus) from (0,0) to (1,1). AUC provides an aggregate measure of performance across all possible classification thresholds.</p>
<div>
<img src="https://raw.githubusercontent.com/illinois-ipaml/MachineLearningForPhysics/main/img/GraphNeuralNetworks-AUC.png" width=400></img>
</div></section>
</section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1><a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="span-style-color-orange-interaction-network-span">
<h1><span style="color:Orange">Interaction Network</span><a class="headerlink" href="#span-style-color-orange-interaction-network-span" title="Permalink to this heading">#</a></h1>
<p>Now we will look at graph neural networks using the PyTorch Geometric library: <a class="reference external" href="https://pytorch-geometric.readthedocs.io/">https://pytorch-geometric.readthedocs.io/</a>. See <span id="id2">[]</span> for more details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>

<span class="c1"># WGET for colab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;definitions.yml&quot;</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/definitions.yml&quot;</span>
    <span class="n">definitionsFile</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;definitions.yml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="c1"># The FullLoader parameter handles the conversion from YAML</span>
    <span class="c1"># scalar values to Python the dictionary format</span>
    <span class="n">definitions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>


<span class="c1"># You can test with using only 4-vectors by using:</span>
<span class="c1"># if not os.path.exists(&quot;definitions_lorentz.yml&quot;):</span>
<span class="c1">#    url = &quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/definitions_lorentz.yml&quot;</span>
<span class="c1">#    definitionsFile = wget.download(url)</span>
<span class="c1"># with open(&#39;definitions_lorentz.yml&#39;) as file:</span>
<span class="c1">#    # The FullLoader parameter handles the conversion from YAML</span>
<span class="c1">#    # scalar values to Python the dictionary format</span>
<span class="c1">#    definitions = yaml.load(file, Loader=yaml.FullLoader)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span>
<span class="n">spectators</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;spectators&quot;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>

<span class="n">nfeatures</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nfeatures&quot;</span><span class="p">]</span>
<span class="n">nspectators</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nspectators&quot;</span><span class="p">]</span>
<span class="n">nlabels</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;nlabels&quot;</span><span class="p">]</span>
<span class="n">ntracks</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">[</span><span class="s2">&quot;ntracks&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="span-style-color-lightblue-graph-datasets-span">
<h2><span style="color:LightBlue">Graph Datasets</span><a class="headerlink" href="#span-style-color-lightblue-graph-datasets-span" title="Permalink to this heading">#</a></h2>
<p>Here we have to define the graph dataset. We do this in a separate class following this example: <a class="reference external" href="https://pytorch-geometric.readthedocs.io/en/latest/notes/create_dataset.html#creating-larger-datasets">https://pytorch-geometric.readthedocs.io/en/latest/notes/create_dataset.html#creating-larger-datasets</a></p>
<p>Formally, a graph is represented by a triplet <span class="math notranslate nohighlight">\(\mathcal G = (\mathbf{u}, V, E)\)</span>, consisting of a graph-level, or <em>global</em>, feature vector <span class="math notranslate nohighlight">\(\mathbf{u}\)</span>, a set of <span class="math notranslate nohighlight">\(N^v\)</span> nodes <span class="math notranslate nohighlight">\(V\)</span>, and a set of <span class="math notranslate nohighlight">\(N^e\)</span> edges <span class="math notranslate nohighlight">\(E\)</span>.
The nodes are given by <span class="math notranslate nohighlight">\(V = \{\mathbf{v}_i\}_{i=1:N^v}\)</span>, where <span class="math notranslate nohighlight">\(\mathbf{v}_i\)</span> represents the <span class="math notranslate nohighlight">\(i\)</span>th nodeâ€™s attributes.
The edges connect pairs of nodes and are given by <span class="math notranslate nohighlight">\(E = \{\left(\mathbf{e}_k, r_k, s_k\right)\}_{k=1:N^e}\)</span>, where <span class="math notranslate nohighlight">\(\mathbf{e}_k\)</span> represents the <span class="math notranslate nohighlight">\(k\)</span>th edgeâ€™s attributes, and <span class="math notranslate nohighlight">\(r_k\)</span> and <span class="math notranslate nohighlight">\(s_k\)</span> are the indices of the â€œreceiverâ€ and
â€œsenderâ€ nodes, respectively, connected by the <span class="math notranslate nohighlight">\(k\)</span>th edge (from the sender node to the receiver node).
The receiver and sender index vectors are an alternative way of encoding the directed adjacency matrix.</p>
<div>
<img src="https://github.com/jmduarte/capstone-particle-physics-domain/raw/master/weeks/attributes.png" alt="attributes" width="800">
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If in colab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;GraphDataset.py&quot;</span><span class="p">):</span>
    <span class="n">urlDSD</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/GraphDataset.py&quot;</span>
    <span class="n">DSD</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlDSD</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;utils.py&quot;</span><span class="p">):</span>
    <span class="n">urlUtils</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/utils.py&quot;</span>
    <span class="n">utils</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlUtils</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">GraphDataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphDataset</span>

<span class="c1"># For Colab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;ntuple_merged_90.root&quot;</span><span class="p">):</span>
    <span class="n">urlFILE</span> <span class="o">=</span> <span class="s2">&quot;http://opendata.cern.ch/eos/opendata/cms/datascience/HiggsToBBNtupleProducerTool/HiggsToBBNTuple_HiggsToBB_QCD_RunII_13TeV_MC/train/ntuple_merged_90.root&quot;</span>
    <span class="n">dataFILE</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">urlFILE</span><span class="p">)</span>
<span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ntuple_merged_90.root&quot;</span><span class="p">]</span>

<span class="n">graph_dataset</span> <span class="o">=</span> <span class="n">GraphDataset</span><span class="p">(</span>
    <span class="s2">&quot;gdata_train&quot;</span><span class="p">,</span>
    <span class="n">features</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">spectators</span><span class="p">,</span>
    <span class="n">start_event</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stop_event</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
    <span class="n">n_events_merge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">file_names</span><span class="o">=</span><span class="n">file_names</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">GraphDataset</span><span class="p">(</span>
    <span class="s2">&quot;gdata_test&quot;</span><span class="p">,</span>
    <span class="n">features</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">spectators</span><span class="p">,</span>
    <span class="n">start_event</span><span class="o">=</span><span class="mi">8001</span><span class="p">,</span>
    <span class="n">stop_event</span><span class="o">=</span><span class="mi">10001</span><span class="p">,</span>
    <span class="n">n_events_merge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">file_names</span><span class="o">=</span><span class="n">file_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-lightblue-graph-neural-network-span">
<h2><span style="color:LightBlue">Graph Neural Network</span><a class="headerlink" href="#span-style-color-lightblue-graph-neural-network-span" title="Permalink to this heading">#</a></h2>
<p>Here, we recapitulate the â€œgraph networkâ€ (GN) formalism described in this <a class="reference external" href="https://arxiv.org/abs/1612.00222">paper</a>, which generalizes various GNNs and other similar methods.</p>
<p>GNs are graph-to-graph mappings, whose output graphs have the same node and edge structure as the input. Formally, a GN block contains three â€œupdateâ€ functions, <span class="math notranslate nohighlight">\(\phi\)</span>, and three â€œaggregationâ€ functions, <span class="math notranslate nohighlight">\(\rho\)</span>. The stages of processing in a single GN block are:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    \mathbf{e}'_k &amp;= \phi^e\left(\mathbf{e}_k, \mathbf{v}_{r_k}, \mathbf{v}_{s_k}, \mathbf{u} \right) &amp; \mathbf{\bar{e}}'_i &amp;= \rho^{e \rightarrow v}\left(E'_i\right) &amp; \text{(Edge block),} \\
    \mathbf{v}'_i &amp;= \phi^v\left(\mathbf{\bar{e}}'_i, \mathbf{v}_i, \mathbf{u}\right) &amp;
    \mathbf{\bar{e}}' &amp;= \rho^{e \rightarrow u}\left(E'\right) &amp;  \text{(Node block),} \\
    \mathbf{u}' &amp;= \phi^u\left(\mathbf{\bar{e}}', \mathbf{\bar{v}}', \mathbf{u}\right) &amp;
    \mathbf{\bar{v}}' &amp;= \rho^{v \rightarrow u}\left(V'\right) &amp;\text{(Global block).}
\end{align}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(E'_i = \left\{\left(\mathbf{e}'_k, r_k, s_k \right)\right\}_{r_k=i,\; k=1:N^e}\)</span> contains the updated edge features for edges whose receiver node is the <span class="math notranslate nohighlight">\(i^\text{th}\)</span> node, <span class="math notranslate nohighlight">\(E' = \bigcup_i E_i' = \left\{\left(\mathbf{e}'_k, r_k, s_k \right)\right\}_{k=1:N^e}\)</span> is the set of updated edges, and <span class="math notranslate nohighlight">\(V'=\left\{\mathbf{v}'_i\right\}_{i=1:N^v}\)</span> is the set of updated nodes.</p>
<a class="reference internal image-reference" href="https://github.com/jmduarte/capstone-particle-physics-domain/raw/master/weeks/GN-full-block.png"><img alt="GN full block" src="https://github.com/jmduarte/capstone-particle-physics-domain/raw/master/weeks/GN-full-block.png" style="width: 1000px;" /></a>
<p>We will define an interaction network model similar to this <a class="reference external" href="https://arxiv.org/abs/1909.12285">paper</a>, but just modeling the particle-particle interactions. It will take as input all of the tracks (with 48 features) without truncating or zero-padding. Another modification is the use of batch normalization <span id="id3">[]</span> layers to improve the stability of the training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch_geometric.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">EdgeConv</span><span class="p">,</span> <span class="n">global_mean_pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span> <span class="k">as</span> <span class="n">Seq</span><span class="p">,</span> <span class="n">Linear</span> <span class="k">as</span> <span class="n">Lin</span><span class="p">,</span> <span class="n">ReLU</span><span class="p">,</span> <span class="n">BatchNorm1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_scatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">scatter_mean</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaLayer</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="mi">48</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EdgeBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EdgeBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_mlp</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">inputs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span> <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden</span><span class="p">),</span> <span class="n">ReLU</span><span class="p">(),</span> <span class="n">Lin</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_mlp</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">NodeBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NodeBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_mlp_1</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_mlp_2</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden</span><span class="p">),</span>
            <span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">edge_index</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">edge_attr</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_mlp_1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">scatter_mean</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_mlp_2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GlobalBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GlobalBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_mlp</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span>
            <span class="n">Lin</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span> <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden</span><span class="p">),</span> <span class="n">ReLU</span><span class="p">(),</span> <span class="n">Lin</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">scatter_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_mlp</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InteractionNetwork</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InteractionNetwork</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactionnetwork</span> <span class="o">=</span> <span class="n">MetaLayer</span><span class="p">(</span><span class="n">EdgeBlock</span><span class="p">(),</span> <span class="n">NodeBlock</span><span class="p">(),</span> <span class="n">GlobalBlock</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactionnetwork</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">InteractionNetwork</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h2><span style="color:LightBlue">Define the training loop</span><a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">xentropy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="n">leave</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">batch_loss_item</span> <span class="o">=</span> <span class="n">xentropy</span><span class="p">(</span><span class="n">batch_output</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">batch_loss_item</span>
        <span class="n">t</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;loss = </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">batch_loss_item</span><span class="p">))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>  <span class="c1"># to show immediately the update</span>

    <span class="k">return</span> <span class="n">sum_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">xentropy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">sum_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="n">leave</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">xentropy</span><span class="p">(</span><span class="n">batch_output</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">batch_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">batch_loss_item</span> <span class="o">=</span> <span class="n">batch_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;loss = </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">batch_loss_item</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>  <span class="c1"># to show immediately the update</span>
        <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">batch_loss_item</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">sum_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h2><span style="color:LightBlue">Define training, validation, testing data generators</span><a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">DataListLoader</span><span class="p">,</span> <span class="n">Batch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">random_split</span>


<span class="k">def</span><span class="w"> </span><span class="nf">collate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">Batch</span><span class="o">.</span><span class="n">from_data_list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>


<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">valid_frac</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">full_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_dataset</span><span class="p">)</span>
<span class="n">valid_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_frac</span> <span class="o">*</span> <span class="n">full_length</span><span class="p">)</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span>
    <span class="n">graph_dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">full_length</span> <span class="o">-</span> <span class="n">valid_num</span><span class="p">,</span> <span class="n">valid_num</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataListLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">train_loader</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">DataListLoader</span><span class="p">(</span>
    <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">valid_loader</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataListLoader</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">test_loader</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate</span>


<span class="n">train_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
<span class="n">valid_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">)</span>
<span class="n">test_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">full_length</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7501
6001
1500
1886
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h2><span style="color:LightBlue">Train</span><a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">osp</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">stale_epochs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_valid_loss</span> <span class="o">=</span> <span class="mi">99999</span>
<span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">))</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">train_loader</span><span class="p">,</span>
        <span class="n">train_samples</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">valid_loss</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">valid_loader</span><span class="p">,</span>
        <span class="n">valid_samples</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">{:02d}</span><span class="s2">, Training Loss:   </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;           Validation Loss: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">valid_loss</span> <span class="o">&lt;</span> <span class="n">best_valid_loss</span><span class="p">:</span>
        <span class="n">best_valid_loss</span> <span class="o">=</span> <span class="n">valid_loss</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;interactionnetwork_best.pth&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New best model saved to:&quot;</span><span class="p">,</span> <span class="n">modpath</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">modpath</span><span class="p">)</span>
        <span class="n">stale_epochs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stale epoch&quot;</span><span class="p">)</span>
        <span class="n">stale_epochs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">stale_epochs</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Early stopping after </span><span class="si">%i</span><span class="s2"> stale epochs&quot;</span> <span class="o">%</span> <span class="n">patience</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "80ac9b74239f479da19d86743a78eddd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5809f6188524440bbd3a0a9f370473a8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f061aabb91174e419ac21f43425f7f19", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 00, Training Loss:   0.2292
           Validation Loss: 0.1590
New best model saved to: interactionnetwork_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4c1b15e1de0c467fa6597192fcb2be07", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ac184f8c41034a1281a73aca5a2b04f0", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 01, Training Loss:   0.1679
           Validation Loss: 0.1534
New best model saved to: interactionnetwork_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9a251bf4d5664e4a94f47419e7a49f56", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6441a172b7db4bc887a446f21f701bad", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 02, Training Loss:   0.1616
           Validation Loss: 0.1478
New best model saved to: interactionnetwork_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1600c8df1a494e5bb8631033b52d27f5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bd41e0f0c55d450d8088fb9a54bb7b17", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 03, Training Loss:   0.1514
           Validation Loss: 0.1535
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb514954722b4da58e8479c4ba6ce647", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a2697f7aeb3b4642968c23f2e2d32bb4", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 04, Training Loss:   0.1363
           Validation Loss: 0.1318
New best model saved to: interactionnetwork_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ace07a527c464510aff20b51fe9a45c5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1c89c84cfd524ffc93ff797759906956", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 05, Training Loss:   0.1406
           Validation Loss: 0.1477
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f693255e9dab41f1b80aba569037c5a6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f51f745d44b2422aa84507be45cc36ba", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 06, Training Loss:   0.1295
           Validation Loss: 0.1304
New best model saved to: interactionnetwork_best.pth
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "41e02929390945a2ba73a383854527f4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6409d4020ac843ff8fc65f5e8168c0ce", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 07, Training Loss:   0.1298
           Validation Loss: 0.1439
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1e19a406102349719d0d05b21f710f34", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d06f1b3c70fa44408724a8fec81788cb", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 08, Training Loss:   0.1294
           Validation Loss: 0.1491
Stale epoch
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "64f8c1c202914892aa318e67dad944ad", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b564f117845c46e4a15f6e3afbe7599f", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 09, Training Loss:   0.1285
           Validation Loss: 0.1418
Stale epoch
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h2><span style="color:LightBlue">Evaluate on Test Data</span><a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In case you need to load the model from a pth file</span>
<span class="c1"># Trained on all possible inputs (as above in notebook)</span>
<span class="c1"># urlPTH = &quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/interactionnetwork_best_Aug1_AllTraining.pth&quot;</span>
<span class="c1"># pthFile = wget.download(urlPTH)</span>
<span class="c1"># model.load_state_dict(torch.load(&quot;interactionnetwork_best_Aug1_AllTraining.pth&quot;))</span>
<span class="c1"># Trained on 4 vector input (different setup)</span>
<span class="c1"># urlPTH = &quot;https://raw.githubusercontent.com/jmduarte/iaifi-summer-school/main/book/interactionnetwork_best_Aug1_4vec.pth&quot;</span>
<span class="c1"># pthFile = wget.download(urlPTH)</span>
<span class="c1"># model.load_state_dict(torch.load(&quot;interactionnetwork_best_Aug1_4vec.pth&quot;))</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">test_samples</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
<span class="n">y_test_gnn</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_predict_gnn</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">batch_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">y_predict_gnn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">y_test_gnn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">y_test_gnn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_test_gnn</span><span class="p">)</span>
<span class="n">y_predict_gnn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_predict_gnn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c612fc5d8bd84f9396a2f866c00077b2", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mplhep</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hep</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">hep</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ROOT</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_labels</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_scores</span><span class="p">(</span><span class="n">y_pred</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">p_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">p_exp</span> <span class="o">/</span> <span class="n">p_exp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># score for positive class</span>

<span class="c1"># # Coompute scores for DeepSets</span>
<span class="n">y_true_ds</span>   <span class="o">=</span> <span class="n">to_labels</span><span class="p">(</span><span class="n">y_test_ds</span><span class="p">)</span>
<span class="n">y_score_ds</span>  <span class="o">=</span> <span class="n">to_scores</span><span class="p">(</span><span class="n">y_predict_ds</span><span class="p">)</span>

<span class="c1"># Compute scores for GNN</span>
<span class="n">y_true_gnn</span>  <span class="o">=</span> <span class="n">to_labels</span><span class="p">(</span><span class="n">y_test_gnn</span><span class="p">)</span>
<span class="n">y_score_gnn</span> <span class="o">=</span> <span class="n">to_scores</span><span class="p">(</span><span class="n">y_predict_gnn</span><span class="p">)</span>

<span class="c1"># ROC + AUC</span>
<span class="n">fpr_ds</span><span class="p">,</span> <span class="n">tpr_ds</span><span class="p">,</span> <span class="n">thr_ds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_ds</span><span class="p">,</span> <span class="n">y_score_ds</span><span class="p">)</span>
<span class="n">auc_ds</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_ds</span><span class="p">,</span> <span class="n">tpr_ds</span><span class="p">)</span>

<span class="n">fpr_gnn</span><span class="p">,</span> <span class="n">tpr_gnn</span><span class="p">,</span> <span class="n">thr_gnn</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_gnn</span><span class="p">,</span> <span class="n">y_score_gnn</span><span class="p">)</span>
<span class="n">auc_gnn</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_gnn</span><span class="p">,</span> <span class="n">tpr_gnn</span><span class="p">)</span>

<span class="c1"># Plot (x=FPR, y=TPR)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_ds</span><span class="p">,</span> <span class="n">tpr_ds</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;DeepSets, AUC = </span><span class="si">{</span><span class="n">auc_ds</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_gnn</span><span class="p">,</span> <span class="n">tpr_gnn</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;GNN, AUC = </span><span class="si">{</span><span class="n">auc_gnn</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False positive rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True positive rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ef1bbacbdae4ac0f73c2a69653706d235fb94a49bc0a70b1f9f9125a7e8c7b33.png" src="../../_images/ef1bbacbdae4ac0f73c2a69653706d235fb94a49bc0a70b1f9f9125a7e8c7b33.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="span-style-color-orange-acknowledgments-span">
<h2><span style="color:Orange">Acknowledgments</span><a class="headerlink" href="#span-style-color-orange-acknowledgments-span" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Initial version: Mark Neubauer</p>
<ul>
<li><p>Materials from:</p>
<ul>
<li><p><a class="reference external" href="https://pytorch-geometric.readthedocs.io/en/latest/notes/colabs.html">https://pytorch-geometric.readthedocs.io/en/latest/notes/colabs.html</a></p></li>
<li><p><a class="reference external" href="https://jduarte.physics.ucsd.edu/iaifi-summer-school/1.4_gnn_in.html">https://jduarte.physics.ucsd.edu/iaifi-summer-school/1.4_gnn_in.html</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Â© Copyright 2024</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_sources/lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Week_12.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span style="color: blue;"><b>Graph Neural Networks</b></span></p>
      </div>
    </a>
    <a class="right-next"
       href="../Project_02.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span style="color: blue;"><b>Project 02</b></span></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Graph Neural Networks</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-introduction-to-graph-data-span"><span style="color:Orange">Introduction to Graph Data</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-graph-classification-span"><span style="color:Orange">Graph Classification</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-exploring-graph-data-with-pytorch-geometric-span"><span style="color:Orange">Exploring graph data with Pytorch Geometric</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-implementing-a-graph-neural-network-span"><span style="color:LightBlue">Implementing a Graph Neural Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-training-the-model-span"><span style="color:LightBlue">Training the model</span></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-deep-sets-span"><span style="color:Orange">Deep Sets</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-data-loader-span"><span style="color:LightBlue">Data Loader</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-deep-sets-network-span"><span style="color:LightBlue">Deep Sets Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-define-the-training-loop-span"><span style="color:LightBlue">Define the training loop</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-define-training-validation-testing-data-generators-span"><span style="color:LightBlue">Define training, validation, testing data generators</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-train-span"><span style="color:LightBlue">Train</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-evaluate-on-test-data-span"><span style="color:LightBlue">Evaluate on Test Data</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightgreen-auc-and-roc-curves-span"><span style="color:LightGreen">AUC and ROC Curves</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-interaction-network-span"><span style="color:Orange">Interaction Network</span></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-graph-datasets-span"><span style="color:LightBlue">Graph Datasets</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-lightblue-graph-neural-network-span"><span style="color:LightBlue">Graph Neural Network</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><span style="color:LightBlue">Define the training loop</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><span style="color:LightBlue">Define training, validation, testing data generators</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><span style="color:LightBlue">Train</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><span style="color:LightBlue">Evaluate on Test Data</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-orange-acknowledgments-span"><span style="color:Orange">Acknowledgments</span></a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mark Neubauer
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>